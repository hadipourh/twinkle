/* gist: Integral distinguisher for 3 rounds given in code/zc-sat/results/twinkle_zc_3r_v0.pdf */
/* --------------------------------------------------------------------------------- */

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <time.h>

#define ROUNDS 3
#define TIMES 1000

#define STATE_SIZE (16*128)

#include "my_lib.h"
#include "rc.h"
#include "oracle.h"

int main(){
	srand(time(NULL));

	/* input difference */
	uint64_t *id = mem_alloc(STATE_SIZE);
	const char *binary_id[16] ={
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000010000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
	};
	
	str_to_state(binary_id, id);

	/* output mask */
	uint64_t *out_mask = mem_alloc(STATE_SIZE);
	const char *binary_out_mask[16] ={
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000100000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"00000000000000000000000000000000000000000000000000000000000000000000000000000000",
	};
	
	str_to_state(binary_out_mask, out_mask);

	uint32_t cnt =0;
	for (int i=0; i<TIMES; i++){
		/* initializing state, fstate and key */
		uint64_t *state = mem_alloc(STATE_SIZE);
		uint64_t *fstate = mem_alloc(STATE_SIZE);
		uint64_t *key = mem_alloc(STATE_SIZE);

        /* taking random state and key */
        rand_state(state);
        rand_state(key);

		/* making s' */
		copy(fstate, state, STATE_SIZE);
		xr(fstate, id, STATE_SIZE);

        /* calling oracle */
        oracle(state, key);
        oracle(fstate, key);

		/* output difference */
		uint64_t *out_diff = mem_alloc(STATE_SIZE);
		xr(out_diff, state, STATE_SIZE);
		xr(out_diff, fstate, STATE_SIZE);

        /* taking dot product with output mask. As the input size is 2, so the xor-sum will be 1. */
        if (dot(out_diff, out_mask, STATE_SIZE) ==1){
            cnt++;
        }
    }

    /* printing value */
    printf("\ndot prod count: %d/%d\n", cnt, TIMES);
}
